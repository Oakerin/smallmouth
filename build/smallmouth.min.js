/*! smallmouth v0.3.2 */
var SmallMouth;!function(a){var b=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(([^#]*))?(#(.*))?"),c=function(){function c(d){this._subscribed=!1;var e=b.exec(d),f=e[1],g=e[3],h=e[5],i=e[6],j=(f?f:"")+(g?g:""),h=c.cleanPath((h?h:"")+(i?i:""));j=j?j:a.defaultHost,this._path=h,this._host=j,this._eventRegistry=a.makeEventRegistry(this._host)}return c.prototype.auth=function(a,b){return this.initializeConnection(a,b),this},c.prototype.unauth=function(){return this._largeMouthAdapter.unauth(),this},c.prototype.initializeConnection=function(b,c){this._largeMouthAdapter||(this._largeMouthAdapter=a.makeConnection(this._host,b,c),this._dataRegistry=a.makeDataRegistry(this._host,this._largeMouthAdapter))},c.prototype.on=function(a,b,c,d){return this.initializeConnection(),this._subscribed||(this._dataRegistry.initializeResource(this),this._largeMouthAdapter.subscribe(this._path)),"function"==typeof c?(this._eventRegistry.addEvent(this._path,a,b,d),this._eventRegistry.addEvent(this._path,"cancel",c,d),b.call(d,this._getSnapshot(),{local:!0})):(this._eventRegistry.addEvent(this._path,a,b,c),b.call(c,this._getSnapshot(),{local:!0})),this},c.prototype.off=function(a,b){return this._eventRegistry.removeEvent(this._path,a,b),this},c.prototype.set=function(a,b){if(this.initializeConnection(),this._largeMouthAdapter.authenticated()){var c=this._dataRegistry.updateRegistry(this,a,{onComplete:b});c&&this._eventRegistry.triggerEvent(this._path,"value",this._host,this._getSnapshot(),{local:!0})}else console.error("Not authenticated"),"function"==typeof b&&b.call(this,"Not authenticated");return this},c.prototype.update=function(a,b){if(this.initializeConnection(),this._largeMouthAdapter.authenticated()){var c=this._dataRegistry.updateRegistry(this,a,{merge:!0,onComplete:b});c&&this._eventRegistry.triggerEvent(this._path,"value",this._host,this._getSnapshot(),{local:!0})}else console.error("Not authenticated"),"function"==typeof b&&b.call(this,"Not authenticated");return this},c.prototype.remove=function(a){this.initializeConnection(),this._largeMouthAdapter.authenticated()?(this._dataRegistry.remove(this,{onComplete:a}),this._eventRegistry.triggerEvent(this._path,"value",this._host,this._getSnapshot(),{local:!0})):(console.error("Not authenticated"),"function"==typeof a&&a.call(this,"Not authenticated"))},c.prototype.push=function(a,b){if(this.initializeConnection(),this._largeMouthAdapter.authenticated()){var c=this._largeMouthAdapter.generateId(),d=this.child(c);return"undefined"!=typeof a&&d.set(a,b),d}return console.error("Not authenticated")},c.prototype.child=function(a){return new c(this._host+"/"+this._path+"/"+c.cleanPath(a))},c.prototype.parent=function(){return new c(this._host+"/"+this._path.substring(0,this._path.lastIndexOf("/")))},c.prototype.root=function(){return new c(this._host+"/"+this._path.substring(0,this._path.indexOf("/")))},c.prototype.name=function(){return this._path.substring(this._path.lastIndexOf("/")+1)},c.prototype.postMessage=function(a,b){return this.initializeConnection(),this._largeMouthAdapter.adapter.send(a,b),this},c.prototype.getSocket=function(){return this.initializeConnection(),this._largeMouthAdapter.adapter.socket},c.prototype.toString=function(){return this._path},c.cleanPath=function(a){return a="/"===a.charAt(0)?a.substring(1):a,a="/"===a.charAt(a.length-1)?a.substring(0,a.length-1):a},c.prototype._getSnapshot=function(){var b=this._dataRegistry.getData(this._path);return b?new a.Snapshot(this._path,b,this._host):void 0},c}();a.Resource=c}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){function b(b,c,d){a.makeConnection(b).adapter.send(c,d)}function c(){return Object.keys(a.SERVER_TYPES)}function d(b){a.serverAdapterType=a.SERVER_TYPES[b]}a.hosts={},a.defaultHost="",a.makeConnection=function(b,c,d){return a.hosts[b]||(a.hosts[b]={}),a.hosts[b].connection?a.hosts[b].connection:a.hosts[b].connection=new a.LargeMouthAdapter(b,void 0,c,d)},a.makeDataRegistry=function(b,c){return a.hosts[b]||(a.hosts[b]={}),a.hosts[b].data?a.hosts[b].data:a.hosts[b].data=new a.DataRegistry(b,c)},a.makeEventRegistry=function(b){return a.hosts[b]||(a.hosts[b]={}),a.hosts[b].eventRegistry?a.hosts[b].eventRegistry:a.hosts[b].eventRegistry=new a.EventRegistry(b)},a.postMessage=b,a.getAvailableAdapters=c,a.setSocketAdapter=d}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){var b=function(){function b(a){this.eventRegistry={events:{},children:{}},this._host=a}return b.prototype.addEvent=function(a,b,c,d){var e=this.getEvent(a);return e.events[b]||(e.events[b]=[]),e.events[b].push({callback:c,context:d}),this},b.prototype.removeEvent=function(a,b,c){var d,e=this.getEvent(a);if("undefined"!=typeof b&&null!==b){if(e.events[b]){if("function"!=typeof c)return e.events[b].length=0;for(var f=0,g=e.events[b].length;g>f;f++)if(e.events[b][f].callback===c){d=f;break}"undefined"!=typeof d&&e.events[b].splice(d,1)}}else for(var h=Object.keys(e.events),f=0,g=h.length;g>f;f++)delete e.events[h[f]]},b.prototype.triggerEvent=function(a,b,c,d,e){"undefined"==typeof e&&(e={});var f=this.getEvent(a,{trigger:b,host:c,local:e.local}),g=f.events[b];if(g){for(var h=0,i=g.length;i>h;h++)g[h].callback.call(g[h].context,d,e);return this}},b.prototype.resetRegistry=function(){return this.eventRegistry.events={},this.eventRegistry.children={},this},b.prototype.getEvent=function(b,c){"undefined"==typeof c&&(c={});for(var d=this.eventRegistry,e=b.split("/"),f=e[0],g=0,h=e.length;h>g;g++){if(d.children[e[g]]||(d.children[e[g]]={events:{},children:{}}),"undefined"!=typeof c.trigger){var i=d.events[c.trigger];if(i)for(var j=a.DataRegistry.getDataRegistry(c.host).getData(f),k=new a.Snapshot(f,j,c.host),l=0,m=i.length;m>l;l++)i[l].callback.call(i[l].context,k,c)}d=d.children[e[g]],g&&(f=f+"/"+e[g])}return d},b.getEventRegistry=function(b){return a.hosts[b].eventRegistry},b}();a.EventRegistry=b}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){function b(a){var c={};if("undefined"!=typeof a.value&&null!=a.value)return a.value;if(!a.children||!Object.keys(a.children).length)return null;for(var d in a.children)a.children.hasOwnProperty(d)&&(c[d]=b(a.children[d]),null==c[d]&&delete c[d]);return c}var c=function(){function c(a,b,c){this._path=a,this._host=c,this._data=JSON.parse(JSON.stringify(b)),this.version=b.version}return c.prototype.val=function(){return b(this._data)},c.prototype.child=function(b){b=this._path+"/"+a.Resource.cleanPath(b);var d=a.DataRegistry.getDataRegistry(this._host).getData(b);return d?new c(b,d,this._host):void 0},c.prototype.forEach=function(b){var d=this._data.children;for(var e in d)if(d.hasOwnProperty(e)){var f=this._path+"/"+e,g=b.call(this,new c(f,a.DataRegistry.getDataRegistry(this._host).getData(f),this._host));if(g)return!0}return!1},c.prototype.hasChild=function(b){b=this._path+"/"+a.Resource.cleanPath(b);var c=a.DataRegistry.getDataRegistry(this._host).getData(b);return"undefined"!=typeof c.children||"undefined"!=typeof c.value},c.prototype.hasChildren=function(){return this.numChildren()>0},c.prototype.name=function(){return this._path.substring(this._path.lastIndexOf("/")+1)},c.prototype.numChildren=function(){return this._data.children?Object.keys(this._data.children).length:0},c.prototype.ref=function(){return new a.Resource(this._host+"/"+this._path)},c}();a.Snapshot=c}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){var b=function(){function a(){this.id=(new Date).getTime()+"",this.connected=!1,this.isAuthenticated=!0,this.needsAuth=!1}return a.prototype.connect=function(a,b,c){var d=this;if(a&&!this.socket)return b&&(this.isAuthenticated=!1,this.needsAuth=!0),this.socket=io.connect(a,b?{query:"token="+b}:null),this.onMessage("ready",function(a){d.id=a.id}),this.onMessage("connect",function(){d.connected=!0,d.isAuthenticated=!0,c.call(null)}),this.onMessage("disconnect",function(){d.connected=!1}),this.onMessage("error",function(a){d.connected=!1,d.isAuthenticated=!1,console.error("Unable to connect to LargeMouth backend",a),c.call(null,a)}),this},a.prototype.unauth=function(){return this.needsAuth&&(this.isAuthenticated=!1),this},a.prototype.authenticated=function(){return this.isAuthenticated},a.prototype.onMessage=function(a,b){return this.socket&&this.socket.on(a,b),this},a.prototype.send=function(a,b,c){return this.socket&&this.socket.emit(a,b,c),this},a.prototype.isConnected=function(){return this.connected},a}();a.SocketIOAdapter=b}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){var b=function(){function a(){this.id=(new Date).getTime()+"",this.eventListeners={},this.messageQueue=[]}return a.prototype.connect=function(a){var b=this;if(a&&!this.socket)return this.socket=new SockJS(a),this.socket.onmessage=function(a){var c=JSON.parse(a.data);b.eventListeners[c.type]&&b.eventListeners[c.type](c.data)},this.socket.onopen=function(){for(;b.messageQueue.length;)b.socket.send(b.messageQueue.splice(0,1)[0])},this.onMessage("ready",function(a){b.id=a.id}),this},a.prototype.unauth=function(){return this},a.prototype.authenticated=function(){return!0},a.prototype.onMessage=function(a,b){return this.socket&&(this.eventListeners[a]=b),this},a.prototype.send=function(a,b){var c;return this.socket&&(c=JSON.stringify({type:a,data:b}),this.socket.readyState===SockJS.OPEN?this.socket.send(c):this.messageQueue.push(c)),this},a}();a.SockJSAdapter=b}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){a.SERVER_TYPES={SOCK_JS:"SockJSAdapter",SOCKET_IO:"SocketIOAdapter",NATIVE:"NativeAdapter"},a.serverAdapterType=a.SERVER_TYPES.SOCKET_IO;var b=function(){function b(b,c,d,e){"undefined"==typeof c&&(c=a.serverAdapterType),this._callbackId=0,this.adapter=new a[c](b),this.connect(b,d,e),this._host=b,this._callbacks={}}return b.prototype.generateCallbackId=function(){return++this._callbackId},b.prototype.unauth=function(){return this.adapter.unauth(),this},b.prototype.authenticated=function(){return this.adapter.authenticated()},b.prototype.connect=function(b,c,d){var e=this;return this.adapter.connect(b,c,d),this.adapter.onMessage("set",function(c){a.DataRegistry.getDataRegistry(e._host).serverSetData(c.path,c.value);var d=a.DataRegistry.getDataRegistry(e._host).getData(c.path);a.EventRegistry.getEventRegistry(e._host).triggerEvent(c.path,"value",b,new a.Snapshot(c.path,d,b),{local:!1})}),this.adapter.onMessage("update",function(c){a.DataRegistry.getDataRegistry(e._host).serverUpdateData(c.path,c.value);var d=a.DataRegistry.getDataRegistry(e._host).getData(c.path);a.EventRegistry.getEventRegistry(e._host).triggerEvent(c.path,"value",b,new a.Snapshot(c.path,d,b),{local:!1})}),this.adapter.onMessage("remove",function(c){a.DataRegistry.getDataRegistry(e._host).serverRemove(c.path),a.EventRegistry.getEventRegistry(e._host).triggerEvent(c.path,"value",b,null,{local:!1})}),this.adapter.onMessage("syncComplete",function(a){e.executeCallback(a.reqId,a.err,a.path,a.data)}),this},b.prototype.executeCallback=function(b,c,d,e){"function"==typeof this._callbacks[b]&&(this._callbacks[b](c),delete this._callbacks[b]),c&&d&&(a.DataRegistry.getDataRegistry(this._host).resetData(d,e),a.EventRegistry.getEventRegistry(this._host).triggerEvent(d,"value",this._host,new a.Snapshot(d,a.DataRegistry.getDataRegistry(this._host).getData(d),this._host),{local:!1}))},b.prototype.subscribe=function(b){return this._host?(this.adapter.send("subscribe",{path:b,value:a.DataRegistry.getDataRegistry(this._host).getData(b)}),this):void 0},b.prototype.syncRemote=function(a,b,c,d){if(this._host){if("function"==typeof d){var e=this.generateCallbackId();this._callbacks[e]=d}return this.adapter.send(a,{path:b,value:c,reqId:e}),this}},b.prototype.setRemote=function(a,b,c){return this.syncRemote("set",b,a,c)},b.prototype.removeRemote=function(a,b,c){return this.syncRemote("remove",b,null,c)},b.prototype.generateId=function(){return this.adapter.id+"-"+(new Date).getTime()},b}();a.LargeMouthAdapter=b}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){function b(a,c){if(!(c instanceof Object)||c instanceof String||c instanceof Number||c instanceof Array||c instanceof Boolean)a.value=c,delete a.children;else{a.children||(a.children={}),delete a.value;for(var d in c)c.hasOwnProperty(d)&&(a.children.hasOwnProperty(d)?a.children[d].version++:a.children[d]={children:{},version:0},b(a.children[d],c[d]))}}function c(a,b){if(a.version=b.version,b.value)a.value=b.value;else{a.children||(a.children={});for(var d in b.children)b.children.hasOwnProperty(d)&&(a.children[d]||(a.children[d]={version:0}),c(a.children[d],b.children[d]))}}var d=function(a,b){return function c(a,b,d,e){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;var f=toString.call(a);if(f!=toString.call(b))return!1;switch(f){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var g=d.length;g--;)if(d[g]==a)return e[g]==b;var h=a.constructor,i=b.constructor;if(h!==i&&"function"!=typeof h&&h instanceof h&&"function"==typeof i&&i instanceof i)return!1;d.push(a),e.push(b);var j=0,k=!0;if("[object Array]"==f){if(j=a.length,k=j==b.length)for(;j--&&(k=c(a[j],b[j],d,e)););}else{for(var l in a)if(Object.hasOwnProperty.call(a,l)&&(j++,!(k=Object.hasOwnProperty.call(b,l)&&c(a[l],b[l],d,e))))break;if(k){for(l in b)if(Object.hasOwnProperty.call(b,l)&&!j--)break;k=!j}}return d.pop(),e.pop(),k}(a,b,[],[])},e=function(){function e(a,b){this._largeMouthAdapter=b,this._dataRegistry=JSON.parse(localStorage.getItem("LargeMouth_Registry_"+a))||{version:0},this._host=a}return e.prototype.initializeResource=function(a){return this.getData(a._path)},e.prototype.updateRegistry=function(a,c,e){"undefined"==typeof e&&(e={});var f=this.getData(a._path),g=JSON.parse(JSON.stringify(f));if(e.merge||(f.children={},f.value=null),b(f,c),!d(f,g)){var f=this.getData(a._path,{versionUpdate:!0});return f.version++,this.persistSet(a,e.onComplete),!0}return!1},e.prototype.getData=function(a,b){if(b||(b={}),""==a.trim())return this._dataRegistry;for(var c=a.split("/"),d=this._dataRegistry,e=0,f=c.length;f>e;e++)d.children||(d.children={}),d.children[c[e]]||(d.children[c[e]]={version:0}),b.versionUpdate&&d.version++,delete d.value,d=d.children[c[e]];return d},e.prototype.remove=function(a,b){"undefined"==typeof b&&(b={});var c=a._path;this.removePath(c),a._host&&this.persistRemove(a,b.onComplete)},e.prototype.serverRemove=function(a){this.removePath(a),this.saveToLocalStorage()},e.prototype.removePath=function(a){if(""==a.trim())return this._dataRegistry;for(var b=a.split("/"),c=this._dataRegistry,d=0,e=b.length-1;e>d&&c.children;d++)c=c.children[b[d]],c.version++;delete c.children[b[b.length-1]]},e.prototype.getVersions=function(a){for(var b=a.split("/"),c=this._dataRegistry,d=[],e=0,f=b.length;f>e&&c&&(d.push(c.version),c.children);e++)c=c.children[b[e]];return d},e.prototype.resetData=function(a,b){for(var c=a.split("/"),d=this._dataRegistry,e=0,f=c.length;f>e;e++)d.children||(d.children={}),d.children[c[e]]||(d.children[c[e]]={version:0}),e===c.length-1?"undefined"==typeof b||null==b?delete d.children[c[e]]:d.children[c[e]]=b:d=d.children[c[e]];this.saveToLocalStorage()},e.prototype.serverUpdateData=function(a,b){var d=this.getData(a,{versionUpdate:!0});b&&c(d,b),this.saveToLocalStorage()},e.prototype.serverSetData=function(a,b){var d=this.getData(a,{versionUpdate:!0});d.children={},b&&c(d,b),this.saveToLocalStorage()},e.prototype.resetRegistry=function(){this._dataRegistry.value=null,this._dataRegistry.children={},this._dataRegistry.version=0,this.saveToLocalStorage()},e.prototype.saveToLocalStorage=function(){localStorage.setItem("LargeMouth_Registry_"+this._host,JSON.stringify(this._dataRegistry))},e.prototype.persistSet=function(a,b){this.persist("setRemote",a._path,this.getData(a._path),b)},e.prototype.persistRemove=function(a,b){this.persist("removeRemote",a._path,null,b)},e.prototype.persist=function(a,b,c,d){this.saveToLocalStorage(),this._largeMouthAdapter[a](c,b,d)},e.getDataRegistry=function(b){return a.hosts[b].data},e}();a.DataRegistry=e}(SmallMouth||(SmallMouth={}));var SmallMouth;!function(a){var b=function(){function a(){this.id=(new Date).getTime()+"",this.eventListeners={},this.messageQueue=[]}return a.prototype.unauth=function(){return this},a.prototype.authenticated=function(){return!0},a.prototype.connect=function(a){var b=this;if(a&&!this.socket)return this.socket=new WebSocket(a),this.socket.onmessage=function(a){var c=JSON.parse(a.data);b.eventListeners[c.type]&&b.eventListeners[c.type](c.data)},this.socket.onopen=function(){for(;b.messageQueue.length;)b.socket.send(b.messageQueue.splice(0,1)[0])},this.onMessage("ready",function(a){b.id=a.id}),this},a.prototype.onMessage=function(a,b){return this.socket&&(this.eventListeners[a]=b),this},a.prototype.send=function(a,b){var c;return this.socket&&(c=JSON.stringify({type:a,data:b}),1===this.socket.readyState?this.socket.send(c):this.messageQueue.push(c)),this},a}();a.NativeAdapter=b}(SmallMouth||(SmallMouth={}));